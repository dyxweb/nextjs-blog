## [XSS](https://juejin.cn/post/6844903685122703367)
- Cross-Site Scripting（跨站脚本攻击）简称XSS，是一种代码注入攻击。
- 攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如Cookie等，进而危害数据安全。
- XSS的本质是恶意代码未经过滤与网站正常的代码混在一起，浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。
### XSS的危害
1. 窃取Cookie。
2. 监听用户行为，比如输入账号密码后直接发送到黑客服务器。
3. 修改DOM伪造登录表单。
4. 在页面中生成浮窗广告。
### 注入恶意脚本的方法
- 来自用户的UGC信息
- URL参数
- POST参数
### 存储型XSS
- 常见于带有用户保存数据功能的网站，如论坛发帖、商品评论、用户私信等。
#### 攻击流程
1. 攻击者通过前端页面将恶意代码提交到目标网站的数据库中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在HTML中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。
### 反射型XSS
- 存储型XSS的恶意代码存在数据库里，反射型XSS的恶意代码存在URL里。
- 反射型XSS漏洞常见于通过URL传递参数的功能，如网站搜索、跳转等。
- 一般是通过给别人发送带有恶意代码参数的URL，当URL地址被打开时，特有的恶意代码参数被解析、执行。
#### 攻击流程
1. 攻击者构造出特殊的URL，其中包含恶意代码。
2. 用户打开带有恶意代码的URL时，网站服务端将恶意代码从URL中取出，拼接在HTML中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。
### DOM型XSS
- DOM型XSS攻击中取出和执行恶意代码都由浏览器端完成，属于前端自身的安全漏洞，而其它两种XSS都属于服务端的安全漏洞。
#### 攻击流程
1. 攻击者构造出特殊的URL，其中包含恶意代码。
2. 用户打开带有恶意代码的URL。
3. 用户浏览器接收到响应后解析执行，前端JavaScript取出URL中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。
### XSS攻击的两大要素
1. 攻击者提交恶意代码。
2. 浏览器执行恶意代码。
### XSS的预防
#### 输入侧过滤
- 用户提交时由前端过滤输入然后提交到后端的过滤方式是不可行的，攻击者绕过前端过滤直接构造请求，就可以提交恶意代码了。
- 后端在写入数据库前对输入内容进行过滤然后存储，返回给前端的内容是过滤后的内容是不可行的，因为可能会出现特殊符号转义存储之后前端显示乱码的问题。
- 输入侧过滤能够在某些情况下解决特定的XSS问题，但会引入很多不确定性和乱码问题。在防范XSS攻击时应避免此类方法。
#### 防止浏览器执行恶意代码
- 防止HTML中出现注入。
- 防止JavaScript执行恶意代码。
#### 预防存储型和反射型XSS攻击
> 存储型和反射型XSS都是在服务端取出恶意代码后，插入到响应的HTML里的，攻击者编写的恶意代码被内嵌到HTML中，被浏览器所执行。预防这两种漏洞常见做法如下。

- 改成纯前端渲染（CSR），把代码和数据分隔开。
- 对HTML做充分转义（使用完善的转义库）。
#### 预防DOM型XSS攻击
> DOM型XSS攻击，实际上是网站前端JavaScript代码本身不够严谨，把攻击者注入的恶意代码执行了。

- 在使用innerHTML、outerHTML、document.write()时要特别小心，不要把不可信的数据作为HTML插到页面上，应使用textContent、.setAttribute()等安全的API修改DOM。
- 如果用Vue/React技术栈，不使用v-html/dangerouslySetInnerHTML功能，在前端render阶段避免innerHTML、outerHTML的XSS隐患。
- DOM中的内联事件监听器，如location、onclick、onerror、onload、onmouseover等，`<a>`标签的href属性，JavaScript的eval()、setTimeout()、setInterval()等都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些API，很容易产生安全隐患，应避免此类操作。
#### HttpOnly Cookie
- 禁止JavaScript读取某些敏感Cookie，攻击者完成XSS注入后也无法窃取此Cookie。

```
document.cookie = "cookieName=cookieValue; path=/; HttpOnly";
```
#### 输入内容长度控制
- 对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止XSS发生，但可以增加XSS攻击的难度。
#### 验证码
- 防止脚本冒充用户提交危险操作。
#### Content Security Policy
> 严格的CSP在XSS的防范中可以起到以下作用。

- 禁止加载外域代码，防止复杂的攻击逻辑。
- 禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。
- 禁止内联脚本执行。
- 禁止未授权的脚本执行。
- 合理使用上报可以及时发现XSS，利于尽快修复问题。